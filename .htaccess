# Habilitar el motor de reescritura
RewriteEngine On

# Establecer la ruta base para las reescrituras
RewriteBase /MassMessage/

# Evitar el listado de directorios
Options -Indexes -MultiViews

# Manejo de errores personalizados
ErrorDocument 400 /MassMessage/views/errors/400.php
ErrorDocument 401 /MassMessage/views/errors/401.php
ErrorDocument 403 /MassMessage/views/errors/403.php
ErrorDocument 404 /MassMessage/views/errors/404.php
ErrorDocument 500 /MassMessage/views/errors/500.php
ErrorDocument 503 /MassMessage/views/errors/503.php

# Forzar HTTPS (descomentar en producción)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Redirigir www a no-www (o viceversa según preferencia)
# RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
# RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# Redirigir todas las solicitudes al index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php?url=$1 [L,QSA]

# Configuraciones de seguridad
<IfModule mod_headers.c>
    # Protección XSS
    Header set X-XSS-Protection "1; mode=block"
    
    # Prevenir clickjacking
    Header always append X-Frame-Options "SAMEORIGIN"
    
    # Prevenir MIME type sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # Referrer Policy
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Feature Policy
    Header set Feature-Policy "geolocation 'self'; midi 'none'; sync-xhr 'self'; microphone 'none'; camera 'none'"
    
    # Permissions Policy
    Header set Permissions-Policy "geolocation=(), midi=(), camera=(), usb=(), magnetometer=(), accelerometer=(), gyroscope=()"
    
    # HSTS (HTTP Strict Transport Security)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS
    
    # Content Security Policy (CSP) - Ajustar según necesidades
    Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:;"
    
    # Prevenir cacheo de páginas sensibles
    <FilesMatch "\.(php|html?|css|js|json|xml)$">
        Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
    </FilesMatch>
</IfModule>

# Configuración de PHP
<IfModule mod_php7.c>
    # Mostrar errores solo en desarrollo
    php_flag display_errors on
    php_flag display_startup_errors on
    php_value error_reporting E_ALL
    php_flag log_errors on
    php_value error_log /path/to/php_errors.log
    
    # Configuración de subida de archivos
    php_value upload_max_filesize 10M
    php_value post_max_size 12M
    php_value max_execution_time 300
    php_value max_input_time 300
    php_value max_file_uploads 20
    php_value memory_limit 256M
    
    # Configuración de sesión segura
    php_flag session.cookie_httponly on
    php_flag session.cookie_secure off  # Cambiar a 'on' en producción con HTTPS
    php_flag session.use_only_cookies on
    php_value session.cookie_samesite "Lax"
    php_value session.gc_maxlifetime 1440
    php_value session.cookie_lifetime 0
</IfModule>

# Comprimir archivos
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Configuración de caché para archivos estáticos
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 1 month"
</IfModule>

# Bloquear acceso a archivos sensibles
<FilesMatch "^(\.|composer\.(json|lock|phar)|package\.json|package-lock\.json|Gruntfile\.js|gulpfile\.js|web\.config|phpunit\.xml|\.(env|git|svn|htaccess|htpasswd|gitignore|gitattributes|editorconfig|log|sql|sh|md|txt|dist|config|inc|bak|swp|swo|DS_Store))$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Bloquear acceso a directorios específicos
<IfModule mod_rewrite.c>
    RewriteRule ^(app|config|core|vendor|logs|tmp) - [F,L,NC]
</IfModule>

# Prevenir hotlinking
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^http(s)?://(www\.)?tudominio.com [NC]
    RewriteRule \.(jpg|jpeg|png|gif|webp|css|js)$ - [NC,F,L]
</IfModule>

# Configuración adicional para Apache 2.4+
<IfModule mod_headers.c>
    <FilesMatch "\.(ttf|ttc|otf|eot|woff|woff2|css|js)$">
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
</IfModule>

# Deshabilitar firma del servidor
ServerSignature Off

# Configuración de idioma por defecto
DefaultLanguage es-PE
AddDefaultCharset UTF-8

# Configuración de zona horaria
SetEnv TZ America/Lima